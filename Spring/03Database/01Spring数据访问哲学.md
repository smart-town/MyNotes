# Spring 的数据访问哲学

Spring 的目标之一就是允许我们在开发应用程序时，能够遵循面向对象(OO)原则中的“针对接口编程”。Spring 对数据访问的支持也不例外。

当一个应用程序需要从某种类型的数据库中读取或者写入数据时，为了避免将持久化的逻辑分散到应用的各个组件中，最好将数据访问的功能放到一个或者多个专注于此项任务的子组件中，这样的组件通常称为(data access object, DAO)或者(Repository)

为了避免应用与特定的数据访问策略耦合在一起，编写良好的 Repository 应该以接口的方式暴露功能。即服务对象直接通过 Repository 接口访问持久层。

服务对象通过接口来访问 Repository，这样做会有几个好处，第一，它使得服务对象易于测试，因为它们不再与特定的数据访问实现绑定在一起。实际上，可以为这些数据访问接口创建 mock 实现，这样无需连接数据库就能测试服务对象。而且会显著提升单元测试的效率并且排除因数据不一致所造成的测试失败。

此外数据访问层是以持久化技术无关的方式来进行访问的。持久化方式的选择独立于 Repository，同时只有数据访问相关的方法才通过接口进行暴露。这可以实现灵活的设计，并且切换持久化框架对应用程序其他部分带来的影响最小。如果将数据访问层的实现细节渗透到应用程序的其他部分中，那么整个应用程序将与数据访问层耦合在一起，导致僵化的设计。

显然上面的文字，倾向于将持久层隐藏在接口之后。接口是实现松耦合代码的关键。为了将数据访问层与应用程序的其他部分隔离开来，Spring 所采用的方式之一就是提供统一的异常处理体系，这个异常体系用在了它支持的所有持久化方案中。

## 了解 Spring 的数据访问异常体系

关于 JDBC 中的 SQLException，使用 JDBC 编写代码时如果不强制捕获 SQLException 几乎无法使用 JDBC 做任何事，SQLException 表示在尝试访问数据库时出现了问题，但是这个异常并没有告诉哪里出错了并且该如何处理。

可能导致该异常的常见问题包括：
- 无法连接数据库
- SQL 语句语法错误
- 查询中的表或者列不存在
- 试图进行的操作违反了数据库约束

SQLException 的问题在于捕获到它的时候该如何处理。事实上，能够触发 SQLException 的问题通常不是在 catch 代码中能够解决的。大多数表明发生了致命性错误，如果不能连接到数据库，那么意味着应用不能继续使用了。

如果无法从 SQLException 中恢复那么为何还要捕获。即使对某些 SQLException 有解决方案但是还是要捕获并查看其属性才能知道问题根源的更多信息。这是因为 SQLException 被视为处理数据访问所有问题的通用异常。

一些持久化的框架提供了相对丰富的异常体系，如 Hibernate 提供了二十个左右的异常，分别对应于特定的数据访问问题。这样就可以针对想处理的异常编写 catch 代码。即便如此，这些异常是 Hiberate 所独有的。如果抛出了 Hibernate 所特有的异常，那么对于 Hibernate 的使用将会渗透到应用程序的其他部分。如果不这么做，我们就要捕获持久化平台的异常，然后将其作为平台无关的异常再次抛出。

一方面 JDBC 的异常体系过于简单，另一方面，Hibernate 的异常体系是其本身独有的。我们需要的数据访问异常要具有描述性而又与特定的持久化框架无关。

SpringJDBC 提供的数据访问异常解决了以上两个问题。不同于 JDBC ，Spring 提供了多个数据访问异常，分别描述它们抛出时所对应的问题。尽管 Spring 的异常体系比 JDBC 异常丰富的多，但是它并没有与特定的持久化方式相关联，这意味着我们可以使用 Spring 抛出一致的异常而不用关心所选择的持久化方案。这有助于我们将所选择的持久化方案与数据访问层隔离开来。

SpringJDBC 提供的异常都是继承自 DataAccessException，DataAccessException 特殊之处在于它是一个非检查型异常。即可以不用捕获。

DataAccessException 只是 Spring 处理非检查和检查异常的一个范例。Spring 认为触发异常的很多问题是不能在 catch 中修复的，Spring 使用了非检查型异常，而不是强制开发人员编写 catch 代码块（经常是空的）。这把是否要捕获异常的权力留给了开发人员。

## 数据访问模板化

一个设计模式：**模板方法模式**.模板方法定义过程的主要框架，一个过程本身是固定不变的，但是在某些特定的步骤上，处理过程会将其工作委派给子类来完成特定实现的细节，这是过程中变化的部分。模板方法将过程中与特定实现相关的部分委托给接口，而这个接口的不同实现定义了过程中的具体行为。

这也是 Spring 在数据访问中所使用的模式。不管我们使用何种技术，都要一些特定的数据访问步骤。如，需要获取到一个数据存储的连接并在处理完成后释放资源。这都是数据访问处理过程中的固定步骤，但是每种数据访问方法又会有所不同。我们会查询不同的对象以不同的方式更新数据，这都是数据访问过程中变化的部分。

Spring 将数据访问过程中固定的和可变的部分明确划分为两个不同的类：模板和回调。模板管理过程中固定的部分，而回调处理自定义的数据访问代码。模板类处理——事务控制、管理资源、处理异常；应用程序相关的数据访问——语句、绑定参数、整体结果集在回调的实现中处理。

Spring 为多种持久化框架提供了支持。
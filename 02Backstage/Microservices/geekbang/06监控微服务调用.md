# 监控微服务调用

与单体应用相比，在微服务架构下，一次用户调用会因为服务化拆分后，变成多个不同服务之间的相互调用，这也就需要对拆分后的每个服务都监控起来。

## 前置条件

首先需要清楚三个问题：监控的对象是什么？具体监控哪些指标？从哪些维度监控？

### 监控对象

对于微服务系统来说，监控对象可以分为四个层次：

- **用户端监控**： 通常是指业务直接对用户提供的功能的监控。以微博首页 Feed 为例，它向用户提供了聚合关注的所有人的微博并按照时间顺序浏览的功能，对首页 Feed 功能的监控就属于用户端的监控
- **接口监控**：通常是指业务提供的功能所依赖的具体 RPC 接口的监控。继续以微博首页 Feed 为例，这个功能依赖于用户关注了哪些人的关系服务，每个人发过哪些微博的微博列表服务，以及每条微博具体内容是什么的内容服务。对这几个服务的调用情况的监控就属于接口监控
- **资源监控**：通常是指某个接口依赖的资源的监控，比如用户关注了哪些人的关系服务使用的是 Redis 来存储关注列表，对 Redis 的监控就属于资源监控
- **基础监控**：通常是对服务器本身的健康状况的监控。主要包括 CPU 利用率、内存使用量、IO 读写量、网卡带宽等。对服务器的基本监控也是必不可少的，因为服务器本身的健康状况也是影响服务本身的一个重要因素，比如服务器本身连接的网络交换机上联带宽被打满，会影响到所有部署在这台服务器上的业务。

### 监控指标

- **请求量**：实时请求量 和 统计请求量。实时请求量用`QPS`(Queries Per Second)即每秒查询次数来衡量，它反映了服务调用的实时变化情况。统计请求量一般使用`PV`(Page View)即一段时间内用户的访问量来衡量，比如一天的 PV 代表了服务一天的请求量
- **响应时间**：大多数情况下，可以用一段时间内所有调用的平均耗时来反映请求的响应时间，但是它只代表了请求的平均快慢情况，有时候更关心满请求的数量，为此需要将响应时间划分为多个区间来观察。
- **错误率**：错误率的监控通常用一段时间内调用失败的次数占用调用总次数的比率来衡量，如对于接口的错误率一般用接口返回错误码为 503 的比率来表示

### 监控维度

一般来说要从多个维度对业务进行监控：
- **全局维度**：从整体角度监控对象的请求量、平均耗时、错误率，全局维度的监控一般是为了让你对监控对象的调用请求有个整体了解
- **分机房维度**：一般为了业务的高可用性，服务通常部署在不止一个机房，因为不同机房地域的不同，同一个监控对象的各种指标可能会相差很大，所以需要深入到机房内部去了解
- **单机维度**：即使在同一个机房维度，由于采购年份和批次的不同，位于不同机器上的统一监控对象的各种指标可能也会有很大差异。
- **时间维度**：同一个监控对象，在每天同一时刻各种指标通常也不一样，这种差异要么是由于业务变更导致，要么是运营活动导致。为了了解监控对象各种指标的变化，通常需要与一天前、一周前、一个月前等比较
- **核心维度**：业务上一般会依据重要性对监控对象进行分级，最简单的是分成核心业务和非核心业务。核心业务和非核心业务在部署上必须隔离，分开监控，这样才能对核心业务做重点保障。

对于一个微服务来说，你必须要明确监控哪些对象，哪些指标，并且从不同维度进行监控，才能掌握微服务的调用情况。

## 监控系统原理

显然我们要对服务调用进行监控，首先要能收集到每一次调用的详细信息，包括调用的响应时间、是否成功、调用的发起者和接收者分别是谁，这个过程叫做数据采集。采集到数据之后，要把数据通过一定的方式传输给数据中心进行处理，这个过程叫做数据传输。数据传输过来之后，数据处理中心在按照服务的维度进行聚合，计算出不同服务的请求量、响应时间以及错误率等信息并存储起来，这个过程叫做数据处理。最后再通过接口或者 Dashboard 的形式向外展示服务的调用情况，这个过程叫做数据展示。

监控系统主要包括四个环节：数据采集、数据传输、数据处理和展示。

### 数据采集

通常有两种数据收集方式：
- **服务主动上报**： 这种处理方式通过在业务代码或者服务框架中加入数据收集代码逻辑，在每一次服务调用完成后，主动上报服务的调用信息。
- **代码收集**：这种处理方式通过服务调用后把调用的详细信息记录到本地日志文件中，然后再通过代理去解析本地日志文件，然后在上报服务的调用信息。

无论哪种数据采集方式，首先要考虑的问题就是采样率，也就是采集数据的频率。采样率决定了监控的实时性和精确度，一般来说，采样率越高，监控的实时性也就越高，精确度也就越高，但是采样对系统本身的性能也会有一定影响，尤其是采集后的数据需要写到本地磁盘的时候，过高的采样率会导致写入磁盘的 IO 过高，进而影响到正常的服务调用。所以设置合理的采样率是数据采集的关键，最好可以动态控制。

### 数据传输

- UDP 传输，数据处理单元提供服务器请求地址，数据采集后通过 UDP 协议与服务器建立连接
- Kafaka 传输，将数据采集后发送到指定的 Topic，然后数据处理单元再订阅对应的 Topic，就可以从 Kafka 消息队列中读取到对应的数据

无论采用哪种传输方式，数据格式都十分重要，有其是对带宽敏感以及解析性能要求比较高的场景：二进制协议和文本协议。

### 数据处理

数据处理是对收集来的原始数据进行聚合并存储。通常有两个维度：
- **接口聚合维度**
- **机器聚合维度**

聚合后的数据需要持久化到数据库中存储，所选用的数据库一般分为两种：
- **索引数据库**，如`Elasticsearch`，以倒排索引的数据结构存储，需要查询的时候，根据索引来查询
- **时序数据库**，如`OpenTSDB`，以时序序列数据的方式存储，查询的时候按照时序如 1min、5min 等维度查询

### 数据展示

数据展示将处理后的数据以 Dashboard 的方式展示给用户。

## 总结

服务监控在微服务改造过程中的重要性不言而喻，没有强大的监控能力，改造成微服务架构后，就无法掌控各个不同服务的情况。在遇到调用失败时，如果不能快速发现系统的问题，对于业务来说就是一场灾难。

搭建一个服务监控系统，涉及数据采集、数据传输、数据处理、数据展示等多个环节。每个环节都需要根据自己的业务特点选择合适的解决方案。
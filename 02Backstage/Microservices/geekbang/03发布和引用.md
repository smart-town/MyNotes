# 发布和引用微服务

想要构建微服务，首先要解决的问题就是，服务提供者如何发布一个服务，服务消费者如何引用一个服务。具体来说就是这个服务的接口名是什么？调用这个服务需要传递哪些参数？接口的返回值是什么类型？以及其他一些接口描述信息。

最常用的服务发布和引用的三种方式：
- Restful API
- XML 配置
- IDL 文件

## Restful API

主要被用作 HTTP 或 HTTPS 协议的接口定义，即使在非微服务架构体系下，也被广泛采用。

由于 HTTP 协议本身是一个公开的协议，对于服务消费者而言几乎没有学习成本，所以比较适合用于跨业务平台之间的服务协议。比如你有一个服务，不仅需要在业务部门内部提供服务，还需要向其他业务部门提供服务，甚至开放给外网提供服务，这时候采用 HTTP 协议就比较合适，也省去了沟通服务协议的成本。

## XML 配置

这种方式的服务发布和服务引用主要分三个步骤：
- 服务提供者定义接口，并实现接口
- 服务提供者启动时，通过加载 server.xml 配置文件将接口暴露出去
- 服务消费者启动时，通过加载 client.xml 配置文件引入要调用的接口

通过在服务提供者和服务消费者之间维持一份对等的 XML 配置文件，来保证服务消费者按照服务提供者的约定来进行服务调用。在这种方式下，如果服务者变更了接口定义，不仅需要更新服务提供者加载的接口描述文件 server.xml，还需要同时更新消费者加载的接口描述文件 client.xml 

一般是私有的 RPC 框架会选择 XML 配置这种方式来描述接口，因为私有 RPC 协议的性能要比 HTTP 协议高，所以在对性能要求比较高的场景下，采用 XML 配置的方式比较合适。但是这种方式对业务代码侵入性比较高，XML 配置有变更的时候，服务消费者和提供者都要更新，所以适合公司内部联系比较紧密的业务之间采用。如果要应用到跨部门之间的业务调用，一旦有 XML 配置变更，就需要花费大量精力去协调不同部门做升级工作。所以对于 XML 配置方式的服务描述，一旦涉及到变更，最好是新增接口，不到万不得已不要对原有接口格式做变更。

## IDL 文件

IDL 就是接口描述语言，Interface Description Language。通过一种中立的方式来描述接口，使得在不同平台上运行的对象和不同语言编写的程序可以相互通信交流，比如用 Java 语言提供一个服务，也能被 PHP 语言调用。

也就是说 IDL 主要是用作跨语言平台的服务之间调用，有两种最常用的 IDL: Facebook 开源的 Thrift 协议，Google 开源的 gRPC 协议。

gRPC 协议的服务描述是通过`proto`文件来定义接口，然后再使用`protoc`来生成不同语言平台的客户端和服务端代码，从而具备跨语言服务调用能力。

有一点需要特别注意，在描述接口定义时，IDL 文件需要对接口返回值进行详细定义。如果接口返回值的字段比较多，并且经常变化时，采用 IDL 文件方式的接口定义就不太合适了。一方面可能造成 IDL 文件过大不便维护，另一方面只要 IDL 文件中的接口返回值有变更，都需要同步所有的服务消费者都更新，管理成本就太高了。


## 总结

具体采用哪种服务描述方式是根据具体情况决定的，通常情况下，如果只是企业内部之间的服务调用，并且都是 Java 语言的话，选择 XML 配置方式是最简单的。如果企业内部存在多个服务，并且服务采用的是不同语言平台，建议使用 IDL 文件方式进行描述服务。如果还存在对外开放调用的情形的话，使用 Restful API 方式则更加通用。


# 微服务架构

首先服务提供者按照一定的格式描述服务，向注册中心注册服务，声明自己能够提供哪些服务以及服务的地址是什么，完成服务发布；接下来服务消费者请求注册中心，查询所需要调用服务的地址，然后以约定的通信协议向服务提供者发起请求，得到请求结果后再按照约定的协议解析结果；在服务调用的中，服务的请求耗时、调用量以及成功率等指标都会被记录下来用作监控，调用经过的链路信息会被记录下来，用于故障定位和问题追踪。在这期间，如果调用失败，可以通过重试等服务治理手段来保证成功率。

总结一下，微服务架构下，服务调用主要依赖以下几个基本组件：
- 服务描述
- 注册中心
- 服务框架
- 服务监控
- 服务追踪
- 服务治理

## 1. 服务描述

服务调用首先要解决的问题就是服务如何对外描述。比如你向外提供了一个服务，那么这个服务名叫什么？调用这个服务需要提供哪些信息？调用这个服务返回的结果是什么格式的？该如何解析？这些就是服务描述所要解决的问题。

常用的服务描述方式包括 Restful API、XML 配置以及 IDL 文件三种。

其中 Restful API 通常用于 HTTP 协议的服务描述，并常用 Wiki 或者 Swagger 来进行管理。

XML 配置方式多用于 RPC 协议的服务描述，通过`*.xml`配置文件来定义接口名、参数以及返回类型等。

IDL 文件通常用于 Thrift 和 gRPC 这类跨语言服务调用框架中，比如 gRPC 就是通过 Protobuf 文件来定义服务的接口名、参数以及返回值的数据结构。

## 2. 注册中心

有了服务的接口描述，下一步要解决的就是服务的发布和订阅。就是说你提供了一个服务，如何让外部想要调用你的人知道，这个时候就需要一个类似注册中心的角色，服务提供者将自己提供的服务以及地址登记到注册中心，服务消费者则从注册中心查询所需要调用的服务地址，然后发起请求。

一般来讲，注册中心的工作流程是：

- 服务提供者在启动时，根据服务发布文件中配置的发布信息向注册中心注册自己的服务
- 服务消费者在启动时，根据消费者文件中配置的服务信息向注册中心订阅自己所需要的服务
- 注册中心返回服务提供者地址列表给消费者
- 当服务提供者发生变化，比如有节点新增或者销毁，注册中心将变更通知给服务消费者

## 3. 服务框架

通过注册中心，服务消费者可以获取到服务提供者的地址，有了地址之后就可以发起调用，但是在发起调用之前还需要解决以下几个问题：

1. 服务通信采用什么协议？也就是说服务提供者和服务消费者之间以什么样的协议进行网络通信，是采用 TCP、UDP 协议还是 HTTP 协议，还是采用其他协议
2. 数据传输采用什么方式？服务提供者和消费者之间的数据传输采用哪种方式，同步还是异步，单链接上传输还是多路复用
3. 数据压缩采用什么格式？通常数据传输都会对数据进行压缩，来减少网络传输的数据量，从而减少带宽消耗和网络传输时间，比如常见的 JSON 序列化、Java 对象序列化、Protobuf 序列化等。

## 4. 服务监控

一旦服务消费者和提供者之间能够正常发起服务调用，你就需要对调用情况进行监控，以了解服务是否正常。通常来讲，服务监控主要包括三个流程：
- 指标收集，就是要把每次服务调用的请求耗时以及成功与否收集起来，并上传到集中的数据处理中心
- 数据处理，有了每次调用的请求耗时以及成功与否等信息，就可以计算每秒服务请求量、平均耗时以及成功率等指标
- 数据展示

## 5. 服务追踪

除了需要对服务的调用情况进行监控之外，还需要记录服务调用经过的每一层链路，以便进行问题追踪和故障定位

服务追踪的原理大致如下:

- 服务消费者发起调用前，会在本地按照规则生成一个`requestid`，发起调用时，将`requestid`当做请求参数的一部分传递给服务提供者
- 服务提供者接收到请求后，记录下这次请求的`requestid`，然后处理请求。如果服务提供者继续请求其他服务，会在本地再生成一个自己的`requestid`，然后把两个`requestid`都当做请求参数继续往下传递。

以此类推，通过这种层层往下传递的方式，一次请求，无论最后依赖多少次服务调用、经过多少服务节点，都可以通过最开始的`requestid`串联所有节点，从而达到服务追踪的目的。
# 注册和发现服务

假设已经使用某种方式发布了一个服务，并且已经在一台服务器上部署了服务。那么如果要调用这个服务，应该如何知道这台服务器的地址？

## 注册中心原理

在微服务架构下，主要有三种角色：服务提供者(RPC Server)、服务消费者(RPC Client)和服务注册中心(Registry)：
- RPC Server 提供服务，启动时，根据服务发布文件 server.xml 中的配置信息，向 Registry 注册自身服务，并向 Registry 定期发送心跳汇报存活状态
- RPC Client 调用服务，启动时，根据服务引用文件 client.xml 中的配置信息，向 Registry 订阅服务，把 Registry 返回的服务节点列表缓存在本地内存中，并与 RPC Server 建立连接
- 当 RPC Server 服务发生变更时，Registry 会同步变更，RPC Client 感知后会刷新本地内存中缓存的服务节点列表
- RPC Client 从本地缓存的服务节点列表中，基于负载均衡算法选择一台 RPC Server 发起调用

## 注册中心实现方式

注册中心的实现主要设计几个问题：注册中心需要提供哪些接口，该如何部署；如何存储服务信息；如何监控服务提供者节点的存活；如果服务提供者节点有变化如何通知服务消费者，以及如何控制注册中心的访问权限。

### 注册中心 Api

根据注册中心原理中的描述，注册中心应该提供以下最基本的 API:

- 服务注册接口
- 服务反注册接口
- 心跳汇报接口
- 服务订阅接口
- 服务变更查询接口：服务消费者通过调用服务变更查询接口，获取更新的可用服务节点列表

除此之外，注册中心还必须提供一些后台管理的 Api:
- 服务查询接口
- 服务修改接口

### 集群部署

注册中心一般作为服务提供者和消费者之间的沟通桥梁，它的重要性不言而喻。所以注册中心一般都是采用集群部署来保证高可用性，并通过分布式一致性协议来确保集群中不同节点之间的数据保持一致。

### 目录存储

注册中心一般采用层次化的目录结构

以 Zookeeper 为例：
- 每个目录在 Zk 中称为 znode，并有唯一一个路径标识
- znode 可以包含数据和子 node
- znode 中数据可以有多个版本，如 某 znode 下存有多个数据版本，那么查询这个路径下的数据需要带上版本信息

### 服务健康状态侦测

注册中心除了要支持最基本的服务注册和服务订阅功能之外，还必须具备对服务提供者节点的健康状态监测功能，这样才能保证注册中心中保存的服务节点都是可用的。

### 服务状态变更通知

一旦注册中心探测到有服务提供者节点新加入或被剔除，就必须立即通知所有订阅该服务的服务消费者，刷新本地缓存的服务节点信息，确保服务调用不会请求不可用的服务提供者节点。

### 白名单机制

在实际的微服务测试和部署时，通常包含多套环境，如生产环境一套、测试环境一套。开发在进行业务自测、测试在进行回归测试时，一般都是使用测试环境，部署的 RPC Server 节点注册到了线上注册中心集群，这样的话线上流量就会调用到测试环境下的 RPC Server 节点，可能造成意想不到的后果。

为了防止这种情况发生，注册中心需要提供一个保护机制，你可以把注册中心想象成一个带有门禁的房间，只有拥有门禁卡的 RPC Server 才能进入。在实际使用中，注册中心可以提供一个白名单机制，只有添加到注册中心白名单内部的 RPC Server，才能够调用注册中心的注册接口，这样可以避免测试环境中的节点意外跑到线上环境中去。

## 总结

注册中心可以说是实现服务化的关键。因为服务化后，服务提供者和消费者不在同一个进程中运行，实现了解耦，这就需要一个纽带连接服务提供者和消费者，而注册中心就正好承担了这一角色。此外，服务提供者可以任意伸缩即增加节点或减少节点，通过服务状态健康监测，注册中心可以保持最新的㐏节点信息，并将变化通知给订阅服务的服务消费者。

注册中心一般采用分布式集群部署，来保证高可用性。并且为了异地多活，有的注册中心还采用多 IDC 部署，这对数据一致性产生了很高的要求，这些都是注册中心在实现时必须解决的问题。
# 微服务治理

常用的服务治理手段：

## 节点管理

服务调用失败一般由两类原因引起：服务提供者出现问题，如宕机、进程意外退出等；网络问题，如服务提供者、注册中心、服务消费者任意两者的网络出现问题。对于这两类问题都有两种节点管理手段：

### 注册中心主动摘除机制

这种机制要求服务提供者定时主动向注册中心汇报心跳，注册中心根据服务提供者节点最近一次汇报心跳的时间与上一次汇报心跳时间作比较，如果超出一定时间就认为服务提供者出现问题，继而将节点从服务列表中摘除，并将最近的可用服务节点推送给服务消费者。

### 服务消费者摘除机制

虽然注册中心主动摘除机制可以解决服务提供者节点异常的问题，但是如果是因为注册中心与服务提供者之间网络出现异常，最坏的情况是注册中心会把服务节点全部摘除，导致服务消费者没有可用的服务节点调用，但是其实这时候服务提供者本身是正常的。所以将存活探测机制用于服务消费者这一端更为合理，如果服务消费者调用服务提供者失败，就将这个节点从内存中保存的可用服务提供者节点列表中移除。

## 负载均衡

一般情况下，服务提供者节点不是唯一的，多以集群的方式存在。尤其对于大规模服务调用来说，服务提供者的节点数量可能有成百上千个。由于机器采购批次不同，不同的服务节点本身的配置也可能存在巨大的差异，新采购的机器 CPU 和内存配置可能更高，同等请求量下性能更好。对于服务消费者而言，从服务列表中选取可用节点时，如果能够让配置较高的新机器承担更多流量的话，就能充分利用新机器的性能。常用负载均衡算法：

- 随机算法
- 轮询算法
- 最少活跃调用算法
- 一致性 Hash 算法

## 服务路由

对于服务消费者而言，在内存中的可用服务节点列表中选择哪个节点不仅由负载均衡算法决定，还由路由规则决定。

所谓路由规则，就是通过一定规则如正则表达式来限定服务节点的选择范围。为什么要制定路由规则呢，主要有两个原因：

### 业务存在灰度发布要求
如服务提供者作了变更，但是希望只让部分人使用，然后根据这一部分人的使用反馈，再决定是否作全量发布。这时候，就可以使用类似按照尾号进行灰度的规则限定只有一定比例的人群才会访问新发布的节点。

### 多机房就近访问的需求
大部分业务规模中等及以上的互联网公司，为了业务的高可用性，都会将自己的业务部署在不止一个 IDC 中，这时候就存在一个问题，不同 IDC 之间的访问由于要跨 IDC，通过专线访问尤其是 IDC 相距比较远时延迟就会比较大，对于一些延时敏感的业务就是不可接受的，所以一般尽量选择同一个 IDC 内部的节点，从而减少网络耗时开销。

路由规则的配置通常有**静态配置**和**动态配置**，静态配置即将路由规则存放在服务消费者本地，要改变就需要修改本地配置，上线后才能生效。动态配置路由规则一般存放在注册中心，服务消费者定期去请求注册中心来保持同步。

## 服务容错

服务调用并不总是成功的，对于调用失败的情况，需要有手段自动恢复，来保证调用成功：

- FailOver: 失败自动切换。调用失败后，自动从可用服务节点列表中选择下一个节点重新发起调用。
- FailBack: 失败通知。调用失败后，不再重试，而是根据失败信息来决定后续处理。如对于非幂等调用场景，如果调用失败，不能简单地重试，而是应该查询服务端的状态，看调用到底是否实际生效。如果已经生效就不能重试了。
- FailCache: 失败缓存。服务消费者调用失败或者超时后，不立即发起重试。而是每隔一段时间后再次发起重试。
- FailFast: 快速失败。服务消费者调用一次失败后，不再重试，实际业务执行时，一般非核心的业务调用，会采用快速失败策略。调用失败后记录下失败日志就返回了。
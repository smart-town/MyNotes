# Java NIO

## 认识

IO 操作实际主体是操作系统，在 Java 编程中，一般使用流的方式来处理 IO，所有的 IO 都被视为单个字节的移动，通过`stream`对象一次移动一个字节。流 IO 负责将对象转换为字节，然后再转换为对象。

`NIO`即`New IO`，是在 JDK1.4 才引入的，NIO 和 IO 有相同的目的，但实现方式不同。`NIO`主要用到的是**块**，所以 NIO 要比 IO 效率高很多。

在 Java API 中有两套 NIO，一套针对**标准输入输出 NIO**，另一套就是**网络编程 NIO**。

### 流与块的对比

NIO 和 IO 最大的区别在于数据打包和传输方式。IO 以流的方式处理数据，而 NIO 以块的方式处理数据。

面向流的 IO 一次一个字节地处理数据，一个输入流产生一个字节，一个输出流就消费一个字节。为流式数据创建过滤器就非常容易，链接几个过滤器，以便对数据进行处理操作都非常简单方便。但是面向流的 IO 通常都很慢。

面向块的 IO 系统以块的形式处理数据，每一个操作都在一步中产生或消费一个块，按块要比按流快很多，但是缺少了面向流所具有的简单性。

## 基础概念

`Buffer`和`Channel`是标准 NIO 中的核心。几乎每一个操作中都会用到它们。

`Channel`是对原 IO 中流的模拟，任何来源和目的数据都必须通过一个`Channel`对象，一个`Buffer`实际上是一个容器对象，发给`Channel`的所有对象都必须先放到`Buffer`中。同样从`Channel`中读取的任何数据都要读进`Buffer`中。

### 关于 Buffer

`Buffer`是一个对象，它包含要读进或写入的数据。在`NIO`中数据必须写入到`buffer`中，而在 IO 中，数据写入或读取到`Stream`对象。**应用程序不能直接对 Channel 对象读写，必须通过 Buffer 进行**。

在 NIO 中所有的数据都是用 Buffer 处理的。它是 NIO 读写数据的中转池。`Buffer`实质上是一个数组，通常是一个字节数组，但是也可以是其他类型的数组。但是一个缓冲区不仅仅是一个数组，重要的是它提供了对数据的结构化访问，而且还可以跟踪系统的读写进程。

使用`Buffer`读写数据一般遵循以下步骤：    
- 写入数据到`Buffer`
- 调用`flip`方法
- 从`Buffer`读取数据
- 调用`clear()`或`compact()`方法

当向`Buffer`写入数据的时候，`Buffer`会记录下来写了多少数据。一旦要读取数据，通过`flip()`将`Buffer`从**写模式切换为读模式**，在读模式下，可以读取之前写入到`Buffer`的所有数据。

一旦读取完所有数据，就需要清空缓冲区：`clear()`或`compact()`。`clear()`清空所有数据，`compact`只会清除已读取过的数据。任何未读的数据都会被移到缓冲区的起始处，新写入的数据将放到缓冲区未读数据的后面。

### 关于 Channel

`Channel`是一个对象，可以通过它读取和写入数据，可以将其认为 IO 中流，但是其不同之处在于：    
1. `Channel`是双向的，既可以读也可以写
2. `Channel`可以异步读写
3. 对`Channel`读写必须通过`buffer`对象

即：你永远不会将数据直接写入到`Channel`中，相反是写入到`Buffer`；你也永远不会从`Channel`中读取字节，而是数据从`Channel`读入`Buffer`，再从`Buffer`获取这个字节。

因为`Channel`是双向的，所以`Channel`可以比流更好地反映出底层操作系统的真实情况。Java NIO 中主要有以下几种类型：

- `FileChannel`: 从文件读取数据
- `DatagramChannel`: 读写 UDP 数据
- `SocketChannel`: 读写 TCP 网络数据
- `ServerSocketChannel`: 监听 TCP 连接


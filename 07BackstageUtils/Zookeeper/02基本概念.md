# 基本概念

## 1. 本质功能

Zk 是一个 server，擅长分布式协调功能，功能的本质：Zk 的数据模型是以 znode 的形式存储和组织。与标准文件系统类似，是一个树形结构，根节点是`/`。每个 znode 内部还可以存储不超过 1M 的数据。这些 znode 可以是持久的，还可以是短期的。短期的 znode 当创建它的客户端 session 超时时，会被 Zk 主动删除。有点类似给文件加锁，进程异常退出后，锁立刻解除。

Zk 的数据模型类似文件系统，这没什么特别的。本质上还是 kv 形式，如果 kv 的 value 还要求是 kv 格式，那么就和 Zk 的数据模型一样。表示成树形的格式，更容易表示层级关系。

其节点有如下有趣而又重要的**特性**：

1. 同一时刻多台机器创建同一个节点，只有一个会争抢成功。利用这个特性可以做分布式锁。
2. 临时节点的生命周期和会话一致，会话关闭时则临时节点删除。这个特征经常用来作心跳，动态监控，负载等动作
3. 顺序节点保证节点名全局唯一。这个特点可以用来生成分布式环境下全局自增长 id

## 2. 原语

1. 创建节点
2. 删除节点
3. 更新节点
4. 获取节点信息
5. 权限控制
6. 事件监听

实际上就是对节点的增删改查加上权限控制和事件监听，但是通过对这些原语的组合以及不同场景的使用，可以实现很多用法。

1. 数据发布订阅
2. 负载均衡
3. 命名服务，zookeeper 的节点结构天然支持命名服务，即把信息集中存储，并且以树状管理，方便统一查阅。
4. 分布式协调通知。实际和发布订阅类似，由于引入第三方的 zookeeper，实际上对很多中协调做了解耦
5. 集群管理和master选举，通过以上的第二点特性可以很轻易知道集群机器的存活状况，从而轻松管理集群，通过上面第一点特性可以实现 master 争抢
6. 分布式锁，实际就是第一点特性应用
7. 分布式队列，实际上就是第三点特性的应用

可以发现，**原语就是 zookeeper 的基础，而其他的用法总结无非就是将原语放到不同的场景下的归类罢了。**

在 ZooKeeper 中，有三种角色：`Leader`、`Follower`、`Observer`。*多个机器之间，大家同级，有领导者、有跟随者，在同级之上有观察者*

-----------------
w3cschool

## Zookeeper 基础

在深入了解 Zookeeper 的运作之前，首先看看 Zookeeper 的基本概念。

1. Architecture
2. Hierarchical namespace
3. Session
4. Watches

### 架构

![Zk架构图](file:///home/smalltown/myfile/resources/zookeeper/architecture.jpg)

部分 | 描述
---- | ----
Client客户端|分布式应用集群中的一个节点，从服务器访问信息，对于特定的时间间隔，每个客户端向服务器发送消息以使服务器知道客户端是活跃的。类似的，当客户端连接时，服务器发送确认码，如果连接的服务器没有响应，那么客户端会自动将消息重定向到另一个服务器上。
Server服务器|服务器，Zookeeper 总体中的一个节点，为客户端提供所有的服务。向客户端发送确认码以告知服务器是活跃的。
Ensemble| Zookeeper 的服务器组，形成 ensemble 所需的最小节点数为 3.
Leader | 服务器节点，如果任何连接的节点失败，则执行自动恢复。Leader 在服务启动时被选举
Follower | 跟随 Leader 指令的服务器节点。

### 层次命名空间

Zookeeper 的数据结构是一个类似文件系统的树结构，其中的每个节点称为 znode，每个 znode 由一个名称标识，并用路径`/`分割。

![Zk数据结构](file:///home/smalltown/myfile/resources/zookeeper/znode.jpg)

- 根节点为 `/` ,`/`根目录下，有两个逻辑命名空间`config`和`workers`
- config 命名空间用于集中式配置管理，workers 命名空间用于命名
- 在`config`命名空间下，每个 znode 最多可以存储 1MB 的数据。这与 Unix 文件系统相类似除了父 znode 也可以存储数据。这种结构的主要目的是存储同步数据并描述 znode 的元数据，该结构称为 Zookeeper 的数据模型

Zookeeper 数据模型中的每个 znode 都维护着一个 stat 结构，一个 stat 结构仅仅提供一个 znode 的元数据，它由版本号、操作控制列表(ACL)、时间戳和数据长度组成。

**Znode**的类型：Znode 被分为持久节点、顺序节点和临时节点

- 持久节点：即使在创建该特定的 znode 的客户端断开连接之后，持久节点仍然存在。默认情况下，除非另有说明，否则 znode 都是持久的
- 临时节点：客户端活跃时，临时节点就是有效的。当客户端与 Zookeeper 节点断开时，临时节点会自动删除。因此，只有临时节点不允许有子节点。如果临时节点被删除，则下一个合适的节点将填充其位置。临时节点在 leader 选举中起着重要作用
- 顺序节点：顺序节点可以是临时的或持久的，当一个新的 znode 被创建为一个顺序节点的时候，Zookeeper 通过将 10 位的序列号附加到原始名称来设置 znode 的路径，例如如果将具有路径`/myapp`的 znode 创建为顺序节点，则 Zookeeper 会将路径名称更改为 `/myapp0000000001`，并将下一个序列号设置为`0000000002`，如果两个顺序节点是同时创建的，那么 Zookeeper 不会对每个 znode 使用相同的数字，顺序节点在锁定和同步中起着重要的作用。

### 会话

会话对于 Zookeeper 的操作非常重要，会话中的请求按照 FIFO 顺序执行。一旦客户端连接到服务器，将建立会话并向客户端分配**会话ID**。客户端以特定的时间间隔发送心跳以保持会话有效。如果 Zookeeper 集合在超过服务器开启时指定的期间都没有从客户端接收到心跳，则它会判断客户端死机。会话超时通常以毫秒为单位，当会话由于任何原因结束时，在该会话创建的临时节点也会被删除。

### 监视

监视是一种简单的机制，使得客户端收到关于 Zookeeper 集合中的更改的通知。客户端可以在读取特定的 znode 时设置 watches，watches 会向注册的客户端发送任何 znode 客户端注册表更改的通知。

znode 的更改是与 znode 相关的数据的修改或者 znode 子项中的更改，只触发一次 watches。如果客户端想要再次通知，则必须通过另一个读取操作来完成，当连接会话过期时，客户端与服务器连接断开，相关的 watches 也会被删除。
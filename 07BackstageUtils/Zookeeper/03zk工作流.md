# Zookeeper 工作流

一旦 Zk 集合启动，它将等待客户端连接。客户端将连接到 Zk 集合中的一个节点，它可以是 leader 或者 followr 节点，一旦客户端被连接，节点将向特定客户端分配会话 ID 并向客户端发送确认。如果客户端没有收到确认，那么它将尝试连接 zk 集合中的另外一个节点。一旦连接到该节点，客户端将以有规律的间隔向节点发送心跳，以确保连接不会丢失。

- 如果客户端想要读取特定的 znode，它将会向具有 znode 路径的节点发送读取请求，并且节点通过从其自己的数据库获取来返回所请求的 node。
- 如果客户端想要将数据存储在 Zk 集合中，则会将 znode 路径和数据发送到服务器。连接的服务器将该请求转发给 leader，然后 leader 将向所有的 follower 重新发出写入请求，如果只有大部分节点成功响应，则写入请求成功，此时返回成功码给客户端。否则写入请求失败。

## Zk 的 leader 选举

考虑一个集群中有 N 个节点，leader 选举的过程如下：

- 所有节点创建具有相同路径 `/app/leader_election/guid_`的顺序、临时节点
- Zk 集合将附加 10 位序列号到路径，创建的 node 将是`/app/leader_election/guid_000000001`等
- 对于给定的实例，在 znode 中创建最小数字的节点成为 leader。而其他所有节点都是 follower
- 每个 follower 节点监视下一个具有最小数字的 znode，例如创建`znode/leader_election_guid_000000008`的节点将监视`000000007`，创建`0000000007`的节点将监视`0000000006`
- 如果 leader 关闭，则相应的`znode/leader_election_N`会被删除
- 下一个在线的 follower 节点将通过监视器获得关于 leader 移除的通知。
- 下一个在线的 follower 将检查是否存在其他具有最小数字的 znode，如果没有那么他将承担 leader 角色。

leader 选举是一个复杂的过程，但是 Zk 服务使用它非常简单。
# 使用 STOMP

假设需要编写一个 Web 应用程序，并且假设 HTTP 协议不存在，只能使用 TCP 套接字来编写 web 应用。当然我们可能可以完成这一壮举，但是这需要自行设计客户端和服务端都认可的协议。从而实现有效的通信。不过幸好我们有 HTTP ，它解决了 Web 浏览器发起请求以及 Web 服务器响应请求的细节，这样的话，大多数的开发人员就不需要编写低层级的 TCP 套接字通信相关的代码。

直接使用 WebSocket 或者 SockJS 就很类似于我们使用 TCP 套接字来编写 Web 应用。因为没有高层级的线路协议(wire protocol)因此就需要我们定义应用之间发送的消息的语义，还需要确保连接的两端能够遵循这些语义。好消息是我们并非必须要使用原生的 WebSocket，就像 HTTP 在 TCP 套接字之上添加了请求-响应模型一样，STOMP 在 WebSocket 之上提供了一个基于帧的线路模式，来定义消息的语义。

STOMP 的消息格式非常类似于 HTTP 请求的结构，STOMP 帧由命令、一个或者多个头信息以及负载所组成。如：
```
SEND
destination: /app/marco
content-length: 20

{\"message\":\"Marco\"}
```

这个简单的示例中，STOMP 命令是 send，表明会发送一些内容，紧接着是两个头信息，一个用来表示消息要发送到哪里的目的地，另一个则包含了负载的大小。然后紧接着就是一个空行，最后是负载内容。上面例子中是一个 JSON 消息。

STOMP 帧中最有意思的地方恐怕就是 destination 头信息了，它表明 STOMP 是一个消息协议，类似于 JMS 或者 AMQP ，消息会发送到某个目的地。这个目的地可能实际上真的有消息代理作为支撑，(message broker)。另外，消息处理器也可以监听这些目的地，接收所发送过来的消息。

在 WebSocket 通信中，基于浏览器的 js 应用可能会发送消息到一个目的地。这个目的地由服务端的组件来进行处理，其实反过来屎一样的，服务器端的组件也可以发布消息，由 js 客户端的目的地来接收。

Spring 为 STOMP 消息提供了基于 Spring MVC 的编程模型。可以看到在 Spring MVC 控制器中处理 STOMP 消息和处理 HTTP 请求没有太大差别。但是首先需要配置 Spring 启用 STOMP 消息。


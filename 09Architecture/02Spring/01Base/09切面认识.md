# 面向切面

## 什么是

切面能够帮助我们模块化横切关注点。简而言之，横切关注点可以被描述为影响应用多处的功能。例如，安全就是一个横切关注点，应用中的许多方法都会涉及到安全规则。

每个模块的核心功能都是为特定业务领域提供服务，但是这些模块都需要类似的辅助功能，如安全和事务管理。如果要重用通用功能的话，最常见的是集成或委托，但是如果在整个应用中都使用相同的基类，继承往往会导致一个脆弱的对象体系；而使用委托可能需要对委托对象进行复杂的调用。

切面提供了取代集成和委托的另一种可选方案。而且在很多场景下更加清晰简洁。在使用面向切面编程时，我们仍然在一个地方定义通用功能，但是可以通过声明的方式定义这个功能要以何种方式在何处应用。而无需修改受影响的类。横切关注点可以被模块化为特殊的类，这些类被称为切面。这样做有两个好处：首先，现在每个关注点都集中于一个地方，而不是分散到多处代码中；其次，服务模块更加简洁，因为它们只包含主要关注点（核心功能）的代码，而次要关注点的点的代码被转移到切面中了。

## AOP 术语

描述切面的常用术语有：通知(Advice)、切点(pointcut)、连接点(jointpoint)。

*将要进行修饰的对象【目标对象】，所拥有的所有的方法称为连接点，它们都是潜在的切点，选择其中某些点进行处理，则这些点被称为切点。具体处理时，围绕某个切点，可以有多种通知时间点，即前置、后置、环绕、返回、异常。而通知的方式则是引入要具体处理的方法。*

将通知和切点合称为切面——在何时和何处完成其功能。

**织入**: 织入是把切面应用到目标对象并创建新的代理对象的过程，切面在指定的连接点被织入到目标对象中。在目标对象的生命周期里有多个点可以进行织入。

- 编译期：切面在目标类编译时被织入，这种方式需要特殊的编译器，AspectJ 的织入编译器就是以这种方式织入切面的。
- 类加载期：切面在目标类被加载到 JVM 时织入，这种方式需要特殊的类加载器。它可以在目标类被引入引用之前增强该目标类的字节码。 AspectJ5 的加载时织入就支持以这种方式织入切面
- 运行期：切面在应用运行时的某个时刻被织入，一般情况下，AOP 容器会为目标对象动态地创建一个代理对象，Spring AOP 就是以这种方式织入切面的。

## Spring 对 AOP 的支持

并不是所有的 AOP 框架都是相同的，它们可能在连接点模型上有强弱之分。有些允许在字段修饰符级别应用通知，而另一些只支持与方法调用相关的连接点。它们织入切面的方式和时机也有所不同。但是无论如何，创建切点来定义切面所织入的连接点是 AOP 框架的基本功能。

Spring 和 AspectJ 项目之间有大量的协作，而且 Spring 对 AOP 的支持在很多方面都借鉴了 AspectJ 项目。Spring 提供四种类型的 AOP 支持：

- 基于代理的经典 Spring AOP
- 纯 POJO 切面
- `@AspectJ`注解驱动的切面
- 注入式`AspectJ`切面

前三种都是 Spring AOP 实现的变体，Spring AOP 构建在动态代理上。因此，Spring 对于 AOP 的支持局限于方法拦截。由于经典 Spring AOP 现在来说比较笨重和繁琐，这里并不介绍。

借助 Spring 的 aop 命名空间，我们可以将纯 POJO 转换为切面，实际上，这些 POJO 只是提供乐满足切点条件时索要调用的方法。遗憾的是，这种技术需要 XML 配置，但是这的确是声明式地将对象转换为切面的简便方式。

Spring 借鉴了 AspectJ 切面，以提供注解驱动的 AOP。本质上，它依然是 Spring 基于代理的 AOP，但是编程模型几乎和编程成熟的 AspectJ 注解切面完全一致。这种 AOP 的风格的好处在于能够不使用 XML 来完成功能。

如果你的 AOP 需求超过了简单的方法调用，如构造器或属性拦截，那么就需要考虑使用 AspectJ 来实现切面。这种情况下注入式`AspectJ`就派上用场了。

## Spring 在运行时通知对象

通过在代理类中包裹切面，Spring 在运行期间把切面织入到 Spring 管理的 bean 中，代理类封装了目标类，并拦截被通知方法的调用，再将调用转发给真正的目标 bean，当代理拦截到方法调用时，在调用目标 bean 方法之前，会执行切面逻辑。

## Spring 只支持方法级别的连接点

正如之前所说，通过使用各种 AOP 方案可以支持多种连接点模型。因为 Spring 基于动态代理，所以 Spring 只支持方法连接点。这与一些其他的 AOP 框架是不同的，例如 AspectJ 和 JBoss，除了方法切点，它们还提供了字段和构造器接入点。Spring 缺少对字段连接点的支持，无法让我们创建细粒度的通知。例如拦截对对象字段的修改。而且它不支持构造器连接点，我们就无法在 bean 创建时使用通知。


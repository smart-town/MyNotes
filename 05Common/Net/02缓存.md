# HTTP 缓存

重用已经获取到的资源能够有效提升网站与应用的性能，web 缓存能够减少延迟与网络阻塞，进而减少显示某个资源所用的时间。借助 HTTP 缓存 web 站点更具响应性。

## 各种类型的缓存

缓存是一种保存资源副本并在下次请求时直接使用该副本的技术。当 web 缓存发现请求的资源已经被存储，它会拦截请求返回该资源的拷贝，而不会去源服务器重新下载，这样带来的好处有：缓解源服务器压力提升性能，而对于网站来说，缓存是达到高性能的重要部分。缓存需要合理的配置，因为并不是所有资源都是永久不变的。

缓存有很多分类，通常可以分为：**私有**和**共享**缓存。共享缓存存储的响应能够被多个用户使用。私有缓存只能用于单独用户。这里主要介绍浏览器与代理缓存，除此之外还有网关缓存、反向代理缓存、CDN 等等。

### (私有)浏览器缓存

私有缓存只能应用于单独用户。浏览器缓存拥有用户通过 HTTP 下载的所有文档。这些缓存为浏览过的文档提供前后导航、保存网页、查看源码等功能，可以避免再向服务器发起多余请求。

### (共享)代理缓存

共享缓存可以被多个用户使用。如你的公司可能会架设一个 web 代理作为本地网络基础的一部分提供给用户，这样热门资源就会被重复使用减少网络拥堵与延迟

## 缓存操作的目标

虽然 HTTP 缓存不是必须的，但是重用缓存的资源时必要的。然而常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力，缓存的关键主要包括`request method`和目标`uri`（一般只有 GET 请求才会被缓存）

## 缓存控制

### `Cache-control`头

HTTP/1.1 定义的`Cache-control`头用来区分对缓存机制的支持情况，请求头和响应头都支持该属性，为其提供不同值来定义缓存策略

#### 禁止进行缓存

缓存中不允许存储任何关于客户端请求和服务端响应的内容。每次由客户端发起的请求都会完整下载响应内容。`Cache-Control:no-store`

#### 强制确认缓存

此方式下，每次有请求发出时，缓存会将该请求发送到服务器（该请求会带有与本地缓存相关的验证字段），服务端会验证请求中所描述的缓存是否过期，如果未过期（304）则缓存才使用本地缓存副本。`Cache-Control: no-cache`

#### 私有和公有缓存

`public`指令代表该响应可以被任何中间人（如中间代理）缓存。

`private`代表响应是专用于某单个用户的，中间人不能缓存此响应。该响应只能用于浏览器私有缓存中。`Cache-Control:private[public]`

#### 缓存过期机制

过期机制中最重要的指令是`max-age=<seconds>`，表示资源能够被缓存的最大时间。相对`Expires`而言，`max-age`是从距离请求发起时间的秒数。针对应用中不会改变的文件通常可以设置一定时长以保证缓存有效（图片、css等静态资源）`Cache-Control:max-age=321000`

#### 缓存验证确认

使用了`must-revalidate`指令时就意味着缓存在考虑使用一个陈旧的资源时必须先验证它的状态

#### Pragma 头

向后兼容

## 新鲜度

理论上来讲当一个资源被缓存存储后，该资源可以永久被存储在缓存中。由于缓存只有有限空间用于存储资源副本因此会定期将一些副本删除，这个过程叫做缓存驱逐。另一方面，当服务器上的资源进行了更新，那么缓存中的资源也应该更新。但是由于 HTTP 是 C/S 模式协议，服务器更新一个资源时，不能直接通知客户端及其缓存，所以双方必须为该资源约定一个过期时间，在该过期时间之前，该资源（缓存副本）是新鲜的，当过了过期时间后，该资源就是陈旧的。

驱逐算法用于将陈旧资源替换为新鲜的。需要注意陈旧资源是不会直接被清除或忽略的，当客户端发起请求时，缓存检索到已有一个对应的陈旧资源，则缓存会先将该请求附加一个`If-None-Match`头，然后发送给服务器，以此检查该资源副本是否依然是新鲜的。如果服务器返回 304(Not Modidfied)，则表示资源新鲜，否则会返回带有资源的实体内容返回。

对于含有特定头信息的请求会去计算缓存寿命，如`Cache-Control:max-age=N`，相对的寿命就是 N。通常对于不含该属性的请求会去查看是否包含`Expires`属性，比较`Expires`与头中的`Date`属性判断缓存是否有效。如果两者都没有则找到头中的`Last-Modified`信息，如果有则与`Date`进行计算。

。。。


## 缓存验证

用户点击浏览器刷新时就会开始缓存验证。如果缓存的信息中有`must-revalidate`定义，在浏览过程中也会触发缓存验证。也可以在浏览器中设置为强制验证缓存。

`ETags`，如果响应头中包含`ETag`客户端在以后的请求中会带上`If-None-Match`来验证缓存。

`Last-Modified`则是一种弱校验器。如果响应头中包含该信息则客户端可以在后续请求带上`If-Modified-Since`验证缓存。


# 呈现引擎

呈现引擎的作用自然是“呈现”，也就是在浏览器的屏幕上显示请求的内容。

默认情况下，呈现引擎可以显示 HTML 或者 XML 文档与图片，通过插件还可以显示其他内容。

这里所讨论的浏览器(Firefox、Chrome、Safari)是基于两种呈现引擎构建的。Firefox 使用的是 Gecko，这是 Mozilla 公司“自制”的呈现引擎。而 Safari 和 Chrome 浏览器使用的都是 Webkit。

Webkit 是一种开放源代码呈现引擎，起初用于 Linux 平台，随后由 Apple 公司进行修改，从而支持苹果机器和 Windows。

## 主流程

![呈现引擎基本流程](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/flow.png)

呈现引擎一开始会从网络层获取请求文档的内容，内容的大小一般限制在 8000 个块以内。

然后进行解析 HTML 文档，并将各标记逐个转化为“内容树”上的 DOM 节点。同时也会解析外部 CSS 文件以及样式元素的样式数据。HTML 中这些带有视觉指令的样式信息将用于创建另一个树结构：**呈现树**

呈现树包含多个带有视觉属性的矩形，这些矩形的排列顺序就是它们将在屏幕上显示的顺序。

呈现树构建完毕后，进入**布局**处理阶段，也就是为每个节点分配一个应该出现在屏幕上的确切坐标。

下一阶段是**绘制**，呈现引擎遍历呈现树，由用户界面后端层将每个节点绘制出来。

需要着重指出的是，这是一个渐进的过程。为了达到更好的用户体验，呈现引擎会力求尽快将内容显示在屏幕上，它不必等到整个 HTML 文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接收和处理来自网络的其余内容的同时，呈现引擎会将部分内容解析并显示出来。

webkit 主流程：
![webkit 主流程](./resources/webkitflow.png)

## 呈现引擎的线程

呈现引擎采用了单线程。几乎所有的操作（除了网络操作）都是在单线程中进行的。在 Firefox 和 Safari 中，该线程就是浏览器的主线程。而在 Chrome 浏览器中，该线程是标签进程的主线程。

网络操作由多个并行线程执行。并行连接数是有限的（通常为 2 到 6 个），如 Firefox3 是 6 个。

## 事件循环

浏览器的主线程是事件循环。它是一个无限循环，永远处于接受处理状态，并等待事件发生（如布局和绘制），并进行处理。
```c++
while (!mExiting){
    NS_ProcessNextEvent(thread);
}
```

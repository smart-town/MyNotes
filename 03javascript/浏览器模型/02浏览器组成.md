# 浏览器组成

浏览器的核心是两个部分：渲染引擎和 JavaScript引擎

## 渲染引擎

渲染引擎的作用是，将网页代码渲染为用户视觉可以感知的平面文档。不同的浏览器有不同的渲染引擎。渲染引擎处理网页通常分为四个阶段：
1. 解析代码：HTML 代码解析为 DOM，CSS 代码解析为 CSSOM(CSS Object Model)
2. 对象合成：将 DOM 和 CSSOM 合成一棵渲染树(render tree)
3. 布局：计算出渲染树的布局
4. 绘制：将渲染树绘制到屏幕
以上四步骤并非严格按照顺序执行，往往第一步还没完成，第二步和第三步就已经开始了。所以会看到这种情况：网页的 HTML 还没下载完，但是浏览器就已经显示出内容了。

## 重流和重绘

渲染树转换为网页布局，称为”布局流“，布局显示到页面的这个过程，称为”绘制“，它们都具有阻塞效应，并且会耗费很多时间和计算资源。

页面生成以后，脚本操作和样式表操作，都会触发”重流”和“重绘“，用户的互动也会触发重流和重绘，比如设置了鼠标悬停效果、页面滚动、在输入框中输入文本、改动窗口大小等。

重流和重绘并不一定一起发生，重流必然导致重绘，重绘不一定需要重流。比如改变元素颜色，只会导致重绘，而不会导致重流；改变元素的布局，则会导致重绘和重流。

大多数情况下，浏览器会智能判断，将重流和重绘只限制到相关的子树上面，最小化所耗费的代价，而不会全局重新生成网页。

作为开发者应该尽量设法降低重绘的次数和成本，如尽量不要变动高层的 DOM 元素，而以底层的 DOM 元素的变动代替。再比如，重绘`table`布局和`flex`布局，开销都比较大。

下面是一些优化技巧：
- 读取 DOM 或者写入 DOM，尽量写在一起不要混杂。不要读取一个 DOM 节点，然后立刻写入，接着再读取另一个节点
- 缓存 DOM 信息
- 不要一项一项改变样式，而是使用 CSS class 一次性改变样式。
- 使用 `documentFragment`操作 DOM
- 动画使用`absolute`或`fixed`定位，这样可以减少对其他元素的影响。
- 只在必要时才显示隐藏元素
- 使用`window.requestAnimationFrame()`，因为它可以把代码推迟到下一次重流时执行，而不是立即要求页面重流
- 使用虚拟 DOM 库。

## JavaScript 引擎

JavaScript 引擎的主要作用是，读取网页中的 JavaScript 代码，对其处理后运行。

JavaScript 是一种解释型语言，也就是说，它不需要编译，由解释器实时运行。这样的好处是运行和修改都比较方便，刷新页面就可以重新解释；缺点是每次运行都要调用解释器，系统开销比较大，运行速度慢于编译型语言。

为了提高运行速度，目前的浏览器都将 JavaScript 进行一定程度的编译，生成类似字节码的中间代码以提高运行速度。

早期，浏览器内部对 js 处理过程如下：
1. 读取代码，进行词法分析，将代码分解成词元
2. 对词元进行语法分析，将代码整理为语法树
3. 使用”翻译器“，将代码转为字节码
4. 使用”字节码解释器“，将字节码转为机器码。

//TODO...